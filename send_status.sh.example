#!/bin/bash
# Renders vpsmon dashboard and sends it via Telegram Bot API.
# Copy this file to send_status.sh and fill in your credentials.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VPSMON="$SCRIPT_DIR/zig-out/bin/vpsmon"
OUTPUT="/tmp/vpsmon_$(date +%s).png"

# ── Configure these ──────────────────────────────────────
BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
CHAT_ID="YOUR_TELEGRAM_CHAT_ID"
# ─────────────────────────────────────────────────────────

# 1. Get ASCII output, escape for pango
TEXT=$("$VPSMON" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

# 2. Render to PNG (hacker green on black)
PANGO="<span font='DejaVu Sans Mono 14' foreground='#00FF41'>${TEXT}</span>"
convert \
  -background black \
  -density 96 \
  pango:"$PANGO" \
  -bordercolor black \
  -border 24x16 \
  "$OUTPUT"

# 3. Send via Telegram Bot API
curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
  -F "chat_id=${CHAT_ID}" \
  -F "photo=@${OUTPUT}" \
  -o /dev/null

# 4. Cleanup
rm -f "$OUTPUT"

echo "OK"
